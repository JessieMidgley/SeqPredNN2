# SeqPredNN2
SeqPredNN is a deep feed-forward neural network that predicts the amino acid sequences of protein structures (https://github.com/falategan/SeqPredNN). In this version, various methods have been implemented to reduce the effect of class imbalance on the predictive performance of the model. A weighted loss function achives the best predictions.

## Methods
### Under-sampling
Randomly discards residues to the size of the minority class. This method achieves the worst macro average precision, recall and F1 scores compared to the other methods. 
### Over-sampling
Randomly duplicates residues to the size of the majority class.
### Weighted Loss Function
Incorporates class weights into the Cross Entropy Loss function to decrease the bias towards majority classes. The structures generated from these predicted sequnces bear the greatest similarity to their native structures.
### Thresholding
Implemented in the test phase to scale output predictions to the prior class probabilities. Can be applied successfully with unbalanced data, however, applying thresholding in conjucntion with under-sampling or over-sampling leads to a drop in model performance.
### Two-phase training 
TPT-1 pre-trains the model on a balanced version of the dataset (generated by either under-sampling or oversampling) before re-training only the output layer on the original dataset. TPT-2 pre-trains the model on the original dataset before re-training only the output layer on a balanced version of the dataset. TPT-1-US and TPT-1-OS both resulted in a drop in model performance.

## Usage
1. **Featurise** the proteins using `featurise.py`
 
    ```
    featurise.py -v -o feature_directory chain_list.txt pdb_files divided
    ```
    * chain_list.txt is a text file specifying the protein chains that must be featurised. It contains a newline-separated list of protein chain IDs in the format 1XYZA for chain A of protein 1XYZ
    * pdb_files is a folder containing protein structures in PDB format. The PDB files must be gzipped and named according to the wwpdb archive convention e.g. pdb1xyz.ent.gz
    * The divided/all keyword specifies the structure of the PDB directory, according to the convention used by the wwpdb archive. In a "divided" directory the PDB files are stored in subdirectories named according to the middle 2 characters of the PDB code e.g. protein 1XYZ would be found in pdb_dir/xy/. In an "all" directory all the PDB files are in a single directory
    
2. **Train** the model using the training script of the chosen method:
    
    undersampling/`train_model.py`
    
    oversampling/`train_model_oversampling.py`
    
    weighted_loss/`train_model_weighted.py`
    
    two_phase_training/TPT-1/`train_model_TPT-1-US.py`  *or*  `train_model_TPT-1-OS.py`
    
    two_phase_training/TPT-2/`train_model_TPT-2-US.py`  *or*  `train_model_TPT-2-OS.py`
    
    e.g.
    ```
    train_model.py -r 0.9 -t test_chains.txt -o my_model -e 200 feature_directory balanced
    ```
    * The train ratio (-r) is the fraction of residues assigned to the training dataset. The remaining residues are assigned to a validation set used to evaluate the model during training.
    * The test chain file (-t) specifies which chains should be excluded from the training and validation datasets so that they can be used for independent 
    evaluation of the model.
    * (-o) is used to specify the output directory.
    * (-e) is used to specify the number of epochs for training.
    * The balanced/unbalanced keyword specifies the sampling mode. "unbalanced" sampling partitions all the residues in the features into the training and validation datasets. "balanced" sampling undersamples OR oversamples (depending on the training script used) the residues so that each of the 20 amino acid classes occur the same number of times in the dataset.
    
    To run the training file, `neural_net.py` and `plots.py` must be present in the same directory as the training file.
    

3. **Test** the model using either `prediction.py` or thresholding/`prediction_thresholding.py`
    
    ```
    prediction.py - o predictions feature_directory test_chains.txt my_model/model_parameters.pth
    ```
   * To making predictions using one of the pretrained models (i.e. skipping the featurising and training steps), specify the parameter file of the chosen method:
   
    undersampling/US_parameters.pth
    
    oversampling/OS_parameters.pth
    
    weighted_loss/WL_parameters.pth
    
    two_phase_training/TPT-1/TPT-1-US_parameters.pth  *or*  TPT-1-OS_parameters.pth
    
    two_phase_training/TPT-2/TPT-2-US_parameters.pth`  *or*  TPT-2-OS_parameters.pth 


